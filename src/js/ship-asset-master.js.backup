/**
 * SHIP資産マスタ一覧画面のJavaScript
 */

// グローバル変数
let shipAssetConfig = null;
let shipAssetData = [];

/**
 * asset-master.jsonを読み込む
 */
async function loadAssetMasterConfig() {
    try {
        console.log('Loading asset-master.json...');
        // キャッシュバスターを追加してブラウザキャッシュを回避
        const cacheBuster = new Date().getTime();
        const response = await fetch(`src/data/asset-master.json?v=${cacheBuster}`);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const config = await response.json();
        console.log('Loaded config:', config);
        console.log('All config keys:', Object.keys(config));

        // assetsの存在チェック（必須）
        if (!config.assets) {
            console.error('Missing required fields!');
            console.error('Has assets?', !!config.assets);
            throw new Error('Invalid JSON structure: missing assets');
        }

        // columnsがない場合は動的に生成（フラット構造対応）
        if (!config.columns) {
            console.log('Columns not found, generating default columns for flat structure...');
            config.columns = [
                { id: "checkbox", label: "", field: "checkbox", type: "checkbox", width: "50px" },
                { id: "no", label: "No.", field: "no", type: "number", width: "60px" },
                { id: "category", label: "Category", field: "category", type: "text", width: "100px" },
                { id: "largeClass", label: "大分類", field: "largeClass", type: "text", width: "150px" },
                { id: "mediumClass", label: "中分類", field: "mediumClass", type: "text", width: "150px" },
                { id: "item", label: "品目", field: "item", type: "text", width: "200px" },
                { id: "manufacturer", label: "メーカー", field: "manufacturer", type: "text", width: "150px" },
                { id: "model", label: "型式", field: "model", type: "text", width: "150px" },
                { id: "actions", label: "操作", field: "actions", type: "actions", width: "100px" }
            ];
        }

        shipAssetConfig = config;
        shipAssetData = config.assets;
        console.log('shipAssetConfig set:', shipAssetConfig);
        console.log('shipAssetData set:', shipAssetData);
        return config;
    } catch (error) {
        console.error('Failed to load asset-master.json:', error);
        alert('資産マスタデータの読み込みに失敗しました: ' + error.message);
        return null;
    }
}

/**
 * テーブルヘッダーを動的に生成
 */
function renderAssetTableHeader() {
    console.log('renderAssetTableHeader called');
    console.log('shipAssetConfig:', shipAssetConfig);

    if (!shipAssetConfig) {
        console.error('shipAssetConfig is null or undefined');
        return;
    }

    if (!shipAssetConfig.columns) {
        console.error('shipAssetConfig.columns is undefined');
        return;
    }

    const thead = document.querySelector('#assetTableBody').closest('table').querySelector('thead tr');
    if (!thead) {
        console.error('thead not found');
        return;
    }

    thead.innerHTML = '';

    shipAssetConfig.columns.forEach(column => {
        const th = document.createElement('th');

        if (column.type === 'checkbox') {
            th.innerHTML = '<input type="checkbox" id="selectAllAssets" onchange="handleSelectAllAssets()">';
        } else {
            th.textContent = column.label;
        }

        if (column.width) {
            th.style.width = column.width;
        }

        thead.appendChild(th);
    });

    console.log('Table header rendered successfully');
}

/**
 * テーブルボディを動的に生成
 */
function renderAssetTableBody() {
    if (!shipAssetConfig || !shipAssetData) return;

    const tbody = document.getElementById('assetTableBody');
    if (!tbody) return;

    tbody.innerHTML = '';

    shipAssetData.forEach((asset, index) => {
        const tr = document.createElement('tr');
        tr.dataset.assetId = asset.id;

        shipAssetConfig.columns.forEach(column => {
            const td = document.createElement('td');

            switch (column.type) {
                case 'checkbox':
                    td.innerHTML = '<input type="checkbox" class="row-checkbox" onchange="handleAssetRowSelect()">';
                    break;

                case 'number':
                    if (column.id === 'no') {
                        td.textContent = index + 1;
                    }
                    break;

                case 'actions':
                    td.innerHTML = `<button class="table-action-btn edit" onclick="showAssetEditModal(${asset.id})">編集</button>`;
                    break;

                default:
                    const value = asset[column.field];
                    td.textContent = value || '-';
                    break;
            }

            tr.appendChild(td);
        });

        tbody.appendChild(tr);
    });

    // 件数を更新
    updateAssetCount();
}

/**
 * 件数表示を更新
 */
function updateAssetCount() {
    const visibleRows = document.querySelectorAll('#assetTableBody tr:not([style*="display: none"])');
    const countElement = document.getElementById('assetCount');
    if (countElement) {
        countElement.textContent = `${visibleRows.length}件`;
    }

    const totalElement = document.getElementById('totalAssets');
    const endElement = document.getElementById('displayEnd');
    if (totalElement) totalElement.textContent = visibleRows.length;
    if (endElement) endElement.textContent = visibleRows.length;
}

/**
 * フィルター表示/非表示切り替え
 */
function toggleAssetFilter() {
    const filterHeader = document.getElementById('assetFilterHeader');
    if (filterHeader) {
        if (filterHeader.style.display === 'none') {
            filterHeader.style.display = 'block';
        } else {
            filterHeader.style.display = 'none';
        }
    }
}

/**
 * フィルターリセット
 */
function resetAssetFilter() {
    document.getElementById('filterCategory').value = '';
    document.getElementById('filterLargeClass').value = '';
    document.getElementById('filterMediumClass').value = '';
    document.getElementById('filterItem').value = '';
    filterAssetTable();
}

/**
 * テーブルフィルタリング
 */
function filterAssetTable() {
    const category = document.getElementById('filterCategory').value.toLowerCase();
    const largeClass = document.getElementById('filterLargeClass').value.toLowerCase();
    const mediumClass = document.getElementById('filterMediumClass').value.toLowerCase();
    const item = document.getElementById('filterItem').value.toLowerCase();

    const rows = document.querySelectorAll('#assetTableBody tr');
    let visibleCount = 0;

    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        // フラット構造のテーブル: [checkbox(0), No(1), Category(2), 大分類(3), 中分類(4), 品目(5), メーカー(6), 型式(7), 操作(8)]
        const rowCategory = cells[2]?.textContent.toLowerCase() || '';
        const rowLargeClass = cells[3]?.textContent.toLowerCase() || '';
        const rowMediumClass = cells[4]?.textContent.toLowerCase() || '';
        const rowItem = cells[5]?.textContent.toLowerCase() || '';

        let matchCategory = !category || rowCategory.includes(category);
        let matchLargeClass = !largeClass || rowLargeClass.includes(largeClass);
        let matchMediumClass = !mediumClass || rowMediumClass.includes(mediumClass);
        let matchItem = !item || rowItem.includes(item);

        if (matchCategory && matchLargeClass && matchMediumClass && matchItem) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });

    // 件数表示を更新
    updateAssetCount();
}

/**
 * 全選択チェックボックス処理
 */
function handleSelectAllAssets() {
    const selectAll = document.getElementById('selectAllAssets');
    const checkboxes = document.querySelectorAll('#assetTableBody .row-checkbox');

    checkboxes.forEach(checkbox => {
        const row = checkbox.closest('tr');
        if (row.style.display !== 'none') {
            checkbox.checked = selectAll.checked;
        }
    });

    updateAssetSelectionInfo();
}

/**
 * 行選択チェックボックス処理
 */
function handleAssetRowSelect() {
    const checkboxes = document.querySelectorAll('#assetTableBody .row-checkbox');
    const selectAll = document.getElementById('selectAllAssets');

    const visibleCheckboxes = Array.from(checkboxes).filter(cb => {
        const row = cb.closest('tr');
        return row.style.display !== 'none';
    });

    const allChecked = visibleCheckboxes.length > 0 &&
                       visibleCheckboxes.every(cb => cb.checked);

    selectAll.checked = allChecked;
    updateAssetSelectionInfo();
}

/**
 * 選択情報を更新
 */
function updateAssetSelectionInfo() {
    const checkboxes = document.querySelectorAll('#assetTableBody .row-checkbox:checked');
    const count = checkboxes.length;

    const selectionInfo = document.getElementById('assetSelectionInfo');
    const deleteBtn = document.getElementById('assetDeleteBtn');

    if (selectionInfo) {
        selectionInfo.textContent = `${count}件選択中`;
    }

    if (deleteBtn) {
        deleteBtn.disabled = count === 0;
    }
}

/**
 * Excel出力
 */
function handleAssetExport() {
    alert('Excel出力機能は実装中です');
}

/**
 * 資産削除
 */
function handleAssetDelete() {
    const checkboxes = document.querySelectorAll('#assetTableBody .row-checkbox:checked');
    const count = checkboxes.length;

    if (count === 0) return;

    if (confirm(`選択した${count}件の資産を削除しますか？`)) {
        checkboxes.forEach(checkbox => {
            const row = checkbox.closest('tr');
            const assetId = parseInt(row.dataset.assetId);

            // shipAssetDataから削除
            const index = shipAssetData.findIndex(a => a.id === assetId);
            if (index !== -1) {
                shipAssetData.splice(index, 1);
            }

            row.remove();
        });

        filterAssetTable();
        updateAssetSelectionInfo();
        alert(`${count}件の資産を削除しました`);
    }
}

/**
 * 戻るボタン
 */
function handleAssetBack() {
    // マスタ管理モーダルに戻る、または前の画面に戻る
    const shipAssetPage = document.getElementById('shipAssetMasterPage');
    if (shipAssetPage) {
        shipAssetPage.classList.remove('active');
    }

    // メイン画面を表示
    const mainContainer = document.getElementById('mainContainer');
    if (mainContainer) {
        mainContainer.classList.add('active');
    }
}

/**
 * 新規作成モーダルを表示
 */
function showAssetNewModal() {
    const modal = document.getElementById('assetNewModal');
    if (modal) {
        // フォームをリセット
        const form = document.getElementById('assetNewForm');
        if (form) {
            form.reset();
        }

        modal.classList.add('show');
    }
}

/**
 * 新規作成モーダルを閉じる
 */
function closeAssetNewModal() {
    const modal = document.getElementById('assetNewModal');
    if (modal) {
        modal.classList.remove('show');
    }
}

/**
 * 新規資産登録フォーム送信処理
 * @param {Event} event - フォーム送信イベント
 */
function handleAssetNewSubmit(event) {
    event.preventDefault();

    // フォームデータを取得
    const formData = {
        category: document.getElementById('assetCategory').value,
        largeClass: document.getElementById('assetLargeClass').value,
        mediumClass: document.getElementById('assetMediumClass').value,
        item: document.getElementById('assetItem').value,
        manufacturer: document.getElementById('assetManufacturer').value,
        model: document.getElementById('assetModel').value
    };

    console.log('新規資産データ:', formData);

    // IDを生成（既存データの最大ID + 1）
    const maxId = shipAssetData.length > 0
        ? Math.max(...shipAssetData.map(a => a.id))
        : 0;

    // shipAssetDataに追加（フラット構造）
    const newAsset = {
        id: maxId + 1,
        category: formData.category,
        largeClass: formData.largeClass,
        mediumClass: formData.mediumClass,
        item: formData.item,
        manufacturer: formData.manufacturer,
        model: formData.model
    };

    shipAssetData.push(newAsset);

    // テーブルを再描画
    renderAssetTableBody();

    // モーダルを閉じる
    closeAssetNewModal();

    // 成功メッセージ
    alert(`資産「${formData.item}」を登録しました`);
}

/**
 * 資産編集モーダルを表示
 * @param {number} assetId - 資産ID
 */
function showAssetEditModal(assetId) {
    const modal = document.getElementById('assetEditModal');
    if (!modal) {
        alert(`資産編集機能は実装中です\n\n資産ID: ${assetId} の編集画面を表示します`);
        return;
    }

    // 資産データを取得
    const asset = shipAssetData.find(a => a.id === assetId);
    if (!asset) {
        alert('資産が見つかりません');
        return;
    }

    // フォームに値をセット
    document.getElementById('editAssetId').value = asset.id;
    document.getElementById('editAssetCategory').value = asset.category;
    document.getElementById('editAssetLargeClass').value = asset.largeClass;
    document.getElementById('editAssetMediumClass').value = asset.mediumClass;
    document.getElementById('editAssetItem').value = asset.item;
    document.getElementById('editAssetManufacturer').value = asset.manufacturer;
    document.getElementById('editAssetModel').value = asset.model;

    modal.classList.add('show');
}

/**
 * 編集モーダルを閉じる
 */
function closeAssetEditModal() {
    const modal = document.getElementById('assetEditModal');
    if (modal) {
        modal.classList.remove('show');
    }
}

/**
 * 資産編集フォーム送信処理
 * @param {Event} event - フォーム送信イベント
 */
function handleAssetEditSubmit(event) {
    event.preventDefault();

    const assetId = parseInt(document.getElementById('editAssetId').value);
    const formData = {
        category: document.getElementById('editAssetCategory').value,
        largeClass: document.getElementById('editAssetLargeClass').value,
        mediumClass: document.getElementById('editAssetMediumClass').value,
        item: document.getElementById('editAssetItem').value,
        manufacturer: document.getElementById('editAssetManufacturer').value,
        model: document.getElementById('editAssetModel').value
    };

    // データを更新
    const index = shipAssetData.findIndex(a => a.id === assetId);
    if (index !== -1) {
        shipAssetData[index] = {
            ...shipAssetData[index],
            ...formData
        };
    }

    // テーブルを再描画
    renderAssetTableBody();

    // モーダルを閉じる
    closeAssetEditModal();

    // 成功メッセージ
    alert(`資産「${formData.item}」を更新しました`);
}

/**
 * 資産詳細モーダルを表示
 * @param {number} assetId - 資産ID
 */
function showAssetDetailModal(assetId) {
    alert(`資産詳細機能は実装中です\n\n資産ID: ${assetId} の詳細情報を表示します`);
}

/**
 * ページネーション - 前へ
 */
function goToAssetPreviousPage() {
    alert('前のページへ移動（実装中）');
}

/**
 * ページネーション - 次へ
 */
function goToAssetNextPage() {
    alert('次のページへ移動（実装中）');
}

/**
 * SHIP資産マスタ画面を表示
 */
async function showShipAssetMaster() {
    console.log('showShipAssetMaster called');

    // すべての画面を非表示
    const allPages = document.querySelectorAll('.active');
    allPages.forEach(page => page.classList.remove('active'));

    // SHIP資産マスタ画面を表示
    const shipAssetPage = document.getElementById('shipAssetMasterPage');
    if (shipAssetPage) {
        shipAssetPage.classList.add('active');

        // JSONを読み込んでテーブルを生成
        const config = await loadAssetMasterConfig();

        if (!config) {
            console.error('Failed to load asset master config');
            alert('資産マスタの読み込みに失敗しました。');
            return;
        }

        console.log('Config loaded successfully, rendering table...');
        renderAssetTableHeader();
        renderAssetTableBody();
        console.log('Table rendered');
    } else {
        console.error('shipAssetMasterPage element not found');
    }
}

// 初期化
document.addEventListener('DOMContentLoaded', function() {
    // 新規作成モーダル外クリックで閉じる
    const newModal = document.getElementById('assetNewModal');
    if (newModal) {
        newModal.addEventListener('click', function(e) {
            if (e.target === newModal) {
                closeAssetNewModal();
            }
        });
    }

    // 編集モーダル外クリックで閉じる
    const editModal = document.getElementById('assetEditModal');
    if (editModal) {
        editModal.addEventListener('click', function(e) {
            if (e.target === editModal) {
                closeAssetEditModal();
            }
        });
    }
});

// グローバルに公開
window.toggleAssetFilter = toggleAssetFilter;
window.resetAssetFilter = resetAssetFilter;
window.filterAssetTable = filterAssetTable;
window.handleSelectAllAssets = handleSelectAllAssets;
window.handleAssetRowSelect = handleAssetRowSelect;
window.handleAssetExport = handleAssetExport;
window.handleAssetDelete = handleAssetDelete;
window.handleAssetBack = handleAssetBack;
window.showAssetNewModal = showAssetNewModal;
window.closeAssetNewModal = closeAssetNewModal;
window.handleAssetNewSubmit = handleAssetNewSubmit;
window.showAssetEditModal = showAssetEditModal;
window.closeAssetEditModal = closeAssetEditModal;
window.handleAssetEditSubmit = handleAssetEditSubmit;
window.showAssetDetailModal = showAssetDetailModal;
window.goToAssetPreviousPage = goToAssetPreviousPage;
window.goToAssetNextPage = goToAssetNextPage;
window.showShipAssetMaster = showShipAssetMaster;
